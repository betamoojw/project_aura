<style>
  @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

  .aura-installer {
    --bg: #0b1220;
    --card: #f6f2ec;
    --ink: #14181f;
    --muted: #5b6470;
    --accent: #f59e0b;
    --accent-2: #06b6d4;
    --ok: #10b981;
    --warn: #f97316;
    --bad: #ef4444;
    --ring: rgba(15, 23, 42, 0.2);
    font-family: "Space Grotesk", "Sora", sans-serif;
    color: var(--ink);
  }

  .aura-installer,
  .aura-installer * {
    box-sizing: border-box;
  }

  .aura-frame {
    padding: 0;
    border-radius: 0;
    background: none;
  }

  .aura-card {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: radial-gradient(900px 520px at -10% -20%, rgba(245, 158, 11, 0.12), transparent 55%),
      radial-gradient(900px 520px at 110% -10%, rgba(6, 182, 212, 0.12), transparent 55%),
      var(--card);
    border-radius: 22px;
    padding: clamp(18px, 3vw, 28px);
    box-shadow: 0 22px 60px rgba(4, 9, 20, 0.35);
    border: 1px solid rgba(15, 23, 42, 0.08);
  }

  .aura-top {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 18px;
  }

  .aura-title {
    font-size: clamp(22px, 3vw, 28px);
    font-weight: 700;
    margin: 0 0 6px 0;
  }

  .aura-subtitle {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
  }

  .aura-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .aura-badge {
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    background: #fff6e7;
    border: 1px solid rgba(245, 158, 11, 0.35);
    color: #8a4b00;
  }

  .aura-badge.secondary {
    background: #ecfeff;
    border-color: rgba(6, 182, 212, 0.35);
    color: #036672;
  }

  .aura-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
    gap: clamp(16px, 3vw, 28px);
    align-items: start;
  }

  .aura-side {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 16px;
  }

  .aura-side > * {
    width: 100%;
    max-width: 360px;
  }

  .aura-side > .aura-section-title {
    margin: 0;
  }

  .aura-section-title {
    margin: 10px 0 8px 0;
    font-size: 15px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: #7a4c0a;
  }

  .aura-steps {
    margin: 0 0 12px 18px;
    padding: 0;
    color: var(--ink);
  }

  .aura-steps li {
    margin-bottom: 10px;
    line-height: 1.35;
  }

  .aura-steps strong {
    font-weight: 700;
  }

  .aura-note {
    margin: 12px 0;
    padding: 12px 14px;
    border-radius: 12px;
    background: #fff0f0;
    border: 1px solid rgba(239, 68, 68, 0.25);
    color: #7a1e1e;
    font-size: 14px;
  }

  .aura-troubleshoot {
    margin: 12px 0 16px 0;
    padding: 14px 16px;
    border-radius: 14px;
    background: #fffaf1;
    border: 1px solid rgba(245, 158, 11, 0.25);
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
  }

  .aura-troubleshoot-title {
    font-size: 14px;
    font-weight: 700;
    color: #7a4c0a;
    margin-bottom: 6px;
  }

  .aura-troubleshoot-subtitle {
    font-size: 12px;
    color: #7a4c0a;
    margin-bottom: 10px;
  }

  .aura-troubleshoot-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    grid-template-rows: repeat(2, auto);
    grid-auto-flow: column;
    gap: 10px 16px;
  }

  .aura-troubleshoot-row {
    display: grid;
    grid-template-columns: 26px 1fr;
    gap: 10px;
    align-items: start;
  }

  .aura-troubleshoot-step {
    width: 26px;
    height: 26px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: rgba(245, 158, 11, 0.2);
    color: #8a4b00;
    font-weight: 700;
    font-size: 12px;
    border: 1px solid rgba(245, 158, 11, 0.3);
  }

  .aura-troubleshoot-text {
    font-size: 13px;
    color: #2b2f36;
    line-height: 1.35;
  }

  .aura-action {
    margin-top: 16px;
    padding: 18px;
    border-radius: 16px;
    border: 1px solid rgba(245, 158, 11, 0.28);
    background: linear-gradient(180deg, #fff7ea 0%, #fef3e0 45%, #f7fbff 100%);
    text-align: center;
    position: relative;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
  }

  .aura-action::before {
    content: "";
    position: absolute;
    left: 18px;
    right: 18px;
    top: 0;
    height: 4px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.9), rgba(6, 182, 212, 0.9));
    opacity: 0.7;
    pointer-events: none;
  }

  .aura-action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .aura-btn {
    border: none;
    cursor: pointer;
    padding: 14px 34px;
    border-radius: 999px;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.04em;
    background: linear-gradient(135deg, #ff9800, #f97316);
    color: #1a0f02;
    box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .aura-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(249, 115, 22, 0.35);
  }

  .aura-btn.ghost {
    background: #0b1425;
    color: #e5f6ff;
    box-shadow: none;
  }

  .aura-action-note {
    margin: 12px auto 0;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.45;
    max-width: 540px;
  }

  .aura-status {
    border-radius: 16px;
    padding: 16px;
    background: #111827;
    color: #f8fafc;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 18px 40px rgba(4, 9, 20, 0.35);
  }

  .aura-status-head {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .aura-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #94a3b8;
    box-shadow: 0 0 0 6px rgba(148, 163, 184, 0.15);
  }

  .aura-status[data-state="working"] .aura-dot {
    background: var(--accent);
    box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.2);
  }

  .aura-status[data-state="success"] .aura-dot {
    background: var(--ok);
    box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.2);
  }

  .aura-status[data-state="error"] .aura-dot {
    background: var(--bad);
    box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2);
  }

  .aura-status-title {
    font-size: 16px;
    font-weight: 700;
  }

  .aura-status-desc {
    font-size: 13px;
    color: #cbd5f5;
  }

  .aura-status-percent {
    margin-left: auto;
    font-size: 13px;
    color: #cbd5f5;
  }

  .aura-progress {
    position: relative;
    height: 8px;
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.2);
    overflow: hidden;
    margin: 14px 0;
  }

  .aura-progress-bar {
    height: 100%;
    width: 0%;
    border-radius: 999px;
    background: linear-gradient(90deg, #22d3ee 0%, #f59e0b 100%);
    transition: width 0.2s ease;
  }

  .aura-status-steps {
    display: grid;
    gap: 8px;
  }

  .aura-status-step {
    padding: 8px 10px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    font-size: 13px;
    color: #e2e8f0;
  }

  .aura-status-step.is-active {
    background: rgba(245, 158, 11, 0.2);
    color: #fde68a;
  }

  .aura-status-step.is-done {
    background: rgba(16, 185, 129, 0.2);
    color: #a7f3d0;
  }

  .aura-diagnostics {
    margin-top: 0;
    padding: 14px;
    border-radius: 14px;
    background: linear-gradient(160deg, #fff7ea 0%, #fffdf7 100%);
    color: #7a4c0a;
    border: 1px solid rgba(245, 158, 11, 0.35);
    box-shadow: 0 12px 26px rgba(15, 23, 42, 0.08);
  }

  .aura-diagnostics p {
    margin: 6px 0 12px 0;
    font-size: 13px;
    color: #7a4c0a;
  }

  .aura-footnote {
    margin-top: 0;
    font-size: 12px;
    color: var(--muted);
  }

  @media (max-width: 900px) {
    .aura-grid {
      grid-template-columns: 1fr;
    }

    .aura-side {
      align-items: stretch;
    }

    .aura-side > * {
      max-width: none;
    }

    .aura-troubleshoot-grid {
      grid-template-columns: 1fr;
      grid-template-rows: none;
      grid-auto-flow: row;
    }
  }
</style>

<section class="aura-installer" id="aura-installer">
  <div class="aura-frame">
    <div class="aura-card">
      <div class="aura-top">
        <div>
          <h2 class="aura-title">Step 3: Install Firmware</h2>
          <p class="aura-subtitle">Follow the steps below and keep USB connected during flashing.</p>
        </div>
        <div class="aura-badges">
          <span class="aura-badge">Firmware v1.0.8</span>
          <span class="aura-badge secondary">Chrome / Edge (Desktop)</span>
        </div>
      </div>

      <div class="aura-grid">
        <div>
          <div class="aura-section-title">Installation Process</div>
          <ol class="aura-steps">
            <li>Use <strong>Chrome</strong> or <strong>Edge</strong> on a desktop or laptop.</li>
            <li>Connect the device with a <strong>data USB cable</strong> to the board's <strong>USB-UART port</strong>.</li>
            <li>Click <strong>Full Install</strong> or <strong>Update</strong>, then select the <strong>USB Serial / CH340</strong> port.</li>
            <li>In the installer dialog, click <strong>Install Project Aura</strong>.</li>
          </ol>

          <div class="aura-troubleshoot">
            <div class="aura-troubleshoot-title">Can't find the right port?</div>
            <div class="aura-troubleshoot-subtitle">Try these in order:</div>
            <div class="aura-troubleshoot-grid">
              <div class="aura-troubleshoot-row">
                <div class="aura-troubleshoot-step">1</div>
                <div class="aura-troubleshoot-text">Unplug the USB cable.</div>
              </div>
              <div class="aura-troubleshoot-row">
                <div class="aura-troubleshoot-step">2</div>
                <div class="aura-troubleshoot-text">Click Connect again and check the list.</div>
              </div>
              <div class="aura-troubleshoot-row">
                <div class="aura-troubleshoot-step">3</div>
                <div class="aura-troubleshoot-text">Plug the cable back in and select the new port.</div>
              </div>
              <div class="aura-troubleshoot-row">
                <div class="aura-troubleshoot-step">4</div>
                <div class="aura-troubleshoot-text">If it still does not appear: hold <strong>BOOT</strong>, tap <strong>RESET</strong>, release BOOT.</div>
              </div>
            </div>
          </div>

          <div class="aura-note">
            Important: do <strong>not close this tab</strong> and do <strong>not disconnect USB</strong> during flashing.
          </div>

          <div class="aura-action">
            <div class="aura-action-buttons">
              <esp-web-install-button
                manifest="/wp-content/uploads/aura-installer/manifest.json"
              >
                <button class="aura-btn" slot="activate" type="button" data-action="install-full">FULL INSTALL (ERASES SETTINGS)</button>
              </esp-web-install-button>
              <esp-web-install-button
                manifest="/wp-content/uploads/aura-installer/manifest-update.json"
              >
                <button class="aura-btn ghost" slot="activate" type="button" data-action="install-update">UPDATE (KEEP SETTINGS)</button>
              </esp-web-install-button>
            </div>
            <div class="aura-action-note">Update keeps settings if you leave "Erase device" unchecked in the popup. Full Install resets settings.</div>
          </div>
        </div>

        <div class="aura-side">
          <div class="aura-section-title">Live Status</div>
          <div class="aura-status" data-state="idle">
            <div class="aura-status-head">
              <span class="aura-dot"></span>
              <div>
                <div class="aura-status-title" data-status-title>Ready to install</div>
                <div class="aura-status-desc" data-status-desc>Click Full Install or Update, then select a port.</div>
              </div>
              <div class="aura-status-percent" data-progress-label>0%</div>
            </div>
            <div class="aura-progress">
              <div class="aura-progress-bar" data-progress-bar></div>
            </div>
            <div class="aura-status-steps">
              <div class="aura-status-step" data-step="connect">1. Device connected</div>
              <div class="aura-status-step" data-step="prepare">2. Preparing files</div>
              <div class="aura-status-step" data-step="flash">3. Flashing</div>
              <div class="aura-status-step" data-step="done">4. Done</div>
            </div>
          </div>

          <div class="aura-diagnostics">
            <div class="aura-section-title">Diagnostics</div>
            <p>For serial logs, click <strong>Full Install</strong> or <strong>Update</strong>, pick a port, then choose <strong>Logs &amp; Console</strong> in the installer dialog.</p>
          </div>

          <div class="aura-footnote">
            Supported browsers: Chrome and Edge. Safari/Firefox do not support Web Serial.
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module" src="https://unpkg.com/esp-web-tools@9.4.3/dist/web/install-button.js"></script>
<script>
  (function () {
    var root = document.getElementById("aura-installer");
    if (!root || root.dataset.bound === "1") {
      return;
    }
    root.dataset.bound = "1";

    var statusBox = root.querySelector(".aura-status");
    var statusTitle = root.querySelector("[data-status-title]");
    var statusDesc = root.querySelector("[data-status-desc]");
    var progressBar = root.querySelector("[data-progress-bar]");
    var progressLabel = root.querySelector("[data-progress-label]");
    var stepEls = Array.prototype.slice.call(root.querySelectorAll("[data-step]"));
    var currentDialog = null;
    var pollTimer = null;
    var attrObserver = null;

    function setStatus(state, title, desc, percent) {
      statusBox.setAttribute("data-state", state);
      statusTitle.textContent = title;
      statusDesc.textContent = desc;
      progressBar.style.width = percent + "%";
      progressLabel.textContent = percent + "%";
    }

    function setStepIndex(activeIndex) {
      stepEls.forEach(function (el, idx) {
        el.classList.toggle("is-active", idx === activeIndex);
        el.classList.toggle("is-done", idx < activeIndex);
      });
    }

    function clampPercent(val) {
      var num = Math.max(0, Math.min(100, Math.round(val)));
      return isNaN(num) ? 0 : num;
    }

    function updateFromInstallState(installState) {
      if (!installState || !installState.state) {
        return;
      }
      if (installState.state === "initializing") {
        setStatus("working", "Initializing", "Checking device and port.", 8);
        setStepIndex(0);
      } else if (installState.state === "preparing") {
        setStatus("working", "Preparing", "Downloading and preparing files.", 20);
        setStepIndex(1);
      } else if (installState.state === "erasing") {
        setStatus("working", "Erasing", "Erasing device memory.", 35);
        setStepIndex(1);
      } else if (installState.state === "writing") {
        var percent = clampPercent(installState.details && installState.details.percentage);
        setStatus("working", "Flashing", "Writing firmware to the device.", percent);
        setStepIndex(2);
      } else if (installState.state === "finished") {
        setStatus("success", "Done", "Flashing complete. You can disconnect.", 100);
        setStepIndex(3);
      } else if (installState.state === "error") {
        setStatus("error", "Flashing failed", installState.message || "Please try again.", 0);
        setStepIndex(-1);
      }
    }

    function updateFromDialog() {
      if (!currentDialog) {
        return;
      }
      var dialogState = currentDialog.getAttribute("state");
      syncDialogMode(currentDialog, dialogState);
      hookDialogEvents(currentDialog);
      bindCompletionClose(currentDialog);
      if (dialogState === "ERROR") {
        setStatus("error", "Connection error", currentDialog._error || "Check the cable and try again.", 0);
        setStepIndex(-1);
        return;
      }
      if (dialogState === "DASHBOARD") {
        setStatus("working", "Device connected", "You can start the install.", 5);
        setStepIndex(0);
        return;
      }
      if (dialogState === "PROVISION") {
        setStatus("success", "Flashing complete", "You can set up Wi-Fi.", 100);
        setStepIndex(3);
        return;
      }
      if (dialogState === "INSTALL") {
        updateFromInstallState(currentDialog._installState);
      }
    }

    function getInnerDialog(dialog) {
      if (!dialog || !dialog.shadowRoot) {
        return null;
      }
      return dialog.shadowRoot.querySelector("ewt-dialog");
    }

    function getDialogRoots(dialog) {
      var roots = [];
      if (!dialog || !dialog.shadowRoot) {
        return roots;
      }
      roots.push(dialog.shadowRoot);
      var inner = getInnerDialog(dialog);
      if (inner) {
        roots.push(inner);
        if (inner.shadowRoot) {
          roots.push(inner.shadowRoot);
        }
      }
      return roots;
    }

    function findButtonByText(dialog, regex) {
      var roots = getDialogRoots(dialog);
      var selector = "button, [role='button'], mwc-button, ha-button, ewt-button";
      for (var i = 0; i < roots.length; i += 1) {
        var buttons = roots[i].querySelectorAll(selector);
        for (var j = 0; j < buttons.length; j += 1) {
          var label = (buttons[j].textContent || "").trim();
          if (regex.test(label)) {
            return buttons[j];
          }
        }
      }
      return null;
    }

    function dialogHasText(dialog, regex) {
      var roots = getDialogRoots(dialog);
      for (var i = 0; i < roots.length; i += 1) {
        var text = roots[i].textContent || "";
        if (regex.test(text)) {
          return true;
        }
      }
      return false;
    }

    function closeDialog(dialog) {
      if (!dialog) {
        return;
      }
      if (typeof dialog.close === "function") {
        dialog.close();
        return;
      }
      if (dialog.parentNode) {
        dialog.parentNode.removeChild(dialog);
      }
    }

    function hookDialogEvents(dialog) {
      var roots = getDialogRoots(dialog);
      roots.forEach(function (root) {
        if (!root || root._auraBound) {
          return;
        }
        root._auraBound = true;
        root.addEventListener(
          "click",
          function (event) {
            var target = event.target;
            var button = target && target.closest ? target.closest("button, [role='button']") : null;
            if (!button) {
              return;
            }
            var label = (button.textContent || "").trim().toLowerCase();
            if (label === "next" || label === "done" || label === "close") {
              if (dialogHasText(dialog, /installation complete|success|completed/i)) {
                setTimeout(function () {
                  closeDialog(dialog);
                }, 200);
              }
            }
          },
          true
        );
      });
    }

    function bindCompletionClose(dialog) {
      if (!dialogHasText(dialog, /installation complete|success|completed/i)) {
        return;
      }
      var nextBtn = findButtonByText(dialog, /^next$/i);
      if (nextBtn && !nextBtn._auraNextBound) {
        nextBtn._auraNextBound = true;
        nextBtn.addEventListener("click", function () {
          setTimeout(function () {
            closeDialog(dialog);
          }, 200);
        });
      }
    }

    function getDialogStyleRoot(dialog) {
      var inner = getInnerDialog(dialog);
      if (inner && inner.shadowRoot) {
        return inner.shadowRoot;
      }
      return dialog ? dialog.shadowRoot : null;
    }

    function syncDialogMode(dialog, dialogState) {
      var inner = getInnerDialog(dialog);
      if (!inner) {
        return;
      }
      var state = dialogState || dialog.getAttribute("state") || "";
      inner.setAttribute("data-aura-mode", state === "LOGS" ? "logs" : "install");
    }

    function injectDialogStyles(dialog) {
      var styleRoot = getDialogStyleRoot(dialog);
      if (!styleRoot) {
        return;
      }
      if (styleRoot.querySelector("style[data-aura-override]")) {
        return;
      }
      var style = document.createElement("style");
      style.setAttribute("data-aura-override", "1");
      style.textContent = [
        ":host([data-aura-mode=\"install\"]) .mdc-dialog__container {",
        "  justify-content: flex-start;",
        "  align-items: center;",
        "  padding-left: 6vw;",
        "  padding-right: 0;",
        "}",
        ":host([data-aura-mode=\"install\"]) .mdc-dialog__surface {",
        "  max-width: 520px;",
        "  min-width: 320px;",
        "  width: min(520px, calc(100vw - 48px));",
        "}",
        "@media (min-width: 1200px) {",
        "  :host([data-aura-mode=\"install\"]) .mdc-dialog__container {",
        "    padding-left: 120px;",
        "  }",
        "}",
        ":host([data-aura-mode=\"logs\"]) .mdc-dialog__container {",
        "  justify-content: center;",
        "  padding-left: 0;",
        "  padding-right: 0;",
        "}",
        ":host([data-aura-mode=\"logs\"]) .mdc-dialog__surface {",
        "  max-width: 78vw;",
        "  max-height: 78vh;",
        "}",
        "ewt-console {",
        "  width: calc(72vw - 48px);",
        "  height: 58vh;",
        "}",
        "@media (max-width: 900px) {",
        "  :host([data-aura-mode=\"install\"]) .mdc-dialog__surface {",
        "    width: min(92vw, 520px);",
        "  }",
        "  :host([data-aura-mode=\"logs\"]) .mdc-dialog__surface {",
        "    max-width: 92vw;",
        "    max-height: 85vh;",
        "  }",
        "  ewt-console {",
        "    width: calc(92vw - 48px);",
        "    height: 52vh;",
        "  }",
        "}"
      ].join("\n");
      styleRoot.appendChild(style);
      syncDialogMode(dialog);
    }

    function cleanupDialog() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
      if (attrObserver) {
        attrObserver.disconnect();
        attrObserver = null;
      }
      currentDialog = null;
    }

    function hookDialog(dialog) {
      cleanupDialog();
      currentDialog = dialog;
      injectDialogStyles(dialog);
      hookDialogEvents(dialog);
      setStatus("working", "Device connected", "Port selected, ready to install.", 5);
      setStepIndex(0);

      attrObserver = new MutationObserver(updateFromDialog);
      attrObserver.observe(dialog, { attributes: true, attributeFilter: ["state"] });

      pollTimer = setInterval(function () {
        if (!document.body.contains(dialog)) {
          cleanupDialog();
          setStatus("idle", "Ready to install", "Click Full Install or Update, then select a port.", 0);
          setStepIndex(-1);
          return;
        }
        updateFromDialog();
      }, 300);
    }

    var bodyObserver = new MutationObserver(function () {
      var dialog = document.querySelector("ewt-install-dialog");
      if (dialog && dialog !== currentDialog) {
        hookDialog(dialog);
        injectDialogStyles(dialog);
      }
      if (!dialog && currentDialog) {
        cleanupDialog();
        setStatus("idle", "Ready to install", "Click Full Install or Update, then select a port.", 0);
        setStepIndex(-1);
      }
    });

    bodyObserver.observe(document.body, { childList: true, subtree: true });

  })();
</script>


